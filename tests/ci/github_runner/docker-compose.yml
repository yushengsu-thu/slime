# Please refer to `README.md` for how to setup this GitHub action runner
version: "3.9"

services:
  runner:
    image: ghcr.io/actions/actions-runner:2.328.0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/nvme0n1/slime_ci:/data/slime_ci
      # it requires this folder
      - /home/runner/externals:/home/runner/externals
    deploy:
      # TODO 4 runner + lock gpu when running
      replicas: 1
    restart: always
    environment:
      RUNNER_ALLOW_RUNASROOT: "1"
    privileged: true
    user: root
    # ref: https://github.com/actions/runner/issues/367#issuecomment-2007558723
    # ref: https://github.com/actions/runner
    # args ref: https://github.com/actions/runner/blob/68ff57dbc4c836d50f46602a8a53301fb9513eb4/src/Runner.Listener/CommandSettings.cs#L53
    # TODO seems we should not run config.sh repeatedly
    entrypoint: >
      sh -c "
      cd /mnt/nvme0n1/slime_ci &&
      /home/runner/config.sh --url ${GITHUB_RUNNER_URL} --token ${GITHUB_RUNNER_TOKEN} --unattended --work /mnt/nvme0n1/slime_ci/runner_$(hostname) &&
      /home/runner/run.sh
      "
